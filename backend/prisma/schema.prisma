// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  EDITOR
  USER
}

enum CategoryRole {
  DEALER
  EMPLOYEE
  TECHNICIAN
  STAKEHOLDER
  INTERN
  VENDOR
}

enum VideoStatus {
  UPLOADED
  PROCESSING
  READY
  APPROVED
  REJECTED
}

enum EventType {
  PLAY
  PAUSE
  PROGRESS
  COMPLETE
}

model User {
  id                      String       @id @default(cuid())
  email                   String       @unique
  username                String?      @unique
  passwordHash            String
  passwordMustChange      Boolean      @default(false)
  passwordResetTokenHash  String?
  passwordResetExpiresAt  DateTime?
  createdByAdminId        String?
  createdByAdmin          User?        @relation("AdminCreatedUsers", fields: [createdByAdminId], references: [id], onDelete: SetNull)
  createdUsers            User[]       @relation("AdminCreatedUsers")
  isActive                Boolean      @default(true)
  lastPasswordChangeAt    DateTime?
  role                    Role         @default(USER)
  categoryRole            CategoryRole @default(INTERN)
  tokenVersion            Int          @default(0)
  createdAt               DateTime     @default(now())
  videos                  Video[]
  events                  AnalyticsEvent[]

  @@map("users")
}

model Video {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  status      VideoStatus  @default(UPLOADED)
  categoryRole CategoryRole
  s3Key       String
  hlsPath     String?
  duration    Int?
  thumbnailUrl String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  renditions  Rendition[]
  events      AnalyticsEvent[]

  @@map("videos")
}

model Rendition {
  id        String @id @default(cuid())
  videoId   String
  resolution String
  bitrate   Int
  hlsPath   String
  video     Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("renditions")
}

model AnalyticsEvent {
  id         String    @id @default(cuid())
  videoId    String
  userId     String?
  eventType  EventType
  progress   Int?
  timestamp  DateTime  @default(now())
  deviceInfo String?
  video      Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("analytics_events")
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String   // User who performed the action
  targetUserId String? // User being acted upon (if applicable)
  action      String   // Action type (e.g., 'CATEGORY_ROLE_CHANGE', 'AUTH_ROLE_CHANGE', 'VIDEO_APPROVED', 'VIDEO_REJECTED')
  oldValue    String?  @db.Text // JSON string of old value
  newValue    String?  @db.Text // JSON string of new value
  metadata    String?  @db.Text // Additional metadata as JSON
  timestamp   DateTime @default(now())

  @@index([actorId])
  @@index([targetUserId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}
