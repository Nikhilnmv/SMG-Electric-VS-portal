// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  EDITOR
  USER
}

enum CategoryRole {
  DEALER
  EMPLOYEE
  TECHNICIAN
  STAKEHOLDER
  INTERN
  VENDOR
}

enum VideoStatus {
  UPLOADED
  PROCESSING
  READY
  APPROVED
  REJECTED
}

enum EventType {
  PLAY
  PAUSE
  PROGRESS
  COMPLETE
}

enum LessonStatus {
  UPLOADED
  PROCESSING
  READY
}

model User {
  id                      String       @id @default(cuid())
  email                   String       @unique
  username                String?      @unique
  passwordHash            String
  passwordMustChange      Boolean      @default(false)
  passwordResetTokenHash  String?
  passwordResetExpiresAt  DateTime?
  createdByAdminId        String?
  createdByAdmin          User?        @relation("AdminCreatedUsers", fields: [createdByAdminId], references: [id], onDelete: SetNull)
  createdUsers            User[]       @relation("AdminCreatedUsers")
  isActive                Boolean      @default(true)
  lastPasswordChangeAt    DateTime?
  role                    Role         @default(USER)
  categoryRole            CategoryRole @default(INTERN)
  tokenVersion            Int          @default(0)
  createdAt               DateTime     @default(now())
  videos                  Video[]
  events                  AnalyticsEvent[]
  createdModules          Module[]
  lessonProgress          UserLessonProgress[]

  @@map("users")
}

// DEPRECATED: Video model kept for backward compatibility
// New content should use Module/Lesson structure
model Video {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  status      VideoStatus  @default(UPLOADED)
  categoryRole CategoryRole
  s3Key       String
  hlsPath     String?
  duration    Int?
  thumbnailUrl String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  renditions  Rendition[]
  events      AnalyticsEvent[]

  @@map("videos")
}

model Rendition {
  id        String @id @default(cuid())
  videoId   String
  resolution String
  bitrate   Int
  hlsPath   String
  video     Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("renditions")
}

model Module {
  id              String            @id @default(cuid())
  title           String
  description     String?
  allowedCategories String[]        @default([])
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdById     String
  createdBy       User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  lessons         Lesson[]

  @@index([createdById])
  @@index([allowedCategories])
  @@map("modules")
}

model Lesson {
  id          String        @id @default(cuid())
  moduleId    String
  title       String
  description String?
  videoPath   String?       // folder path for HLS output
  hlsMaster   String?       // master.m3u8 path
  status      LessonStatus  @default(UPLOADED)
  duration    Int?
  thumbnailUrl String?
  order       Int           @default(0) // Order within module
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  module      Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  events      AnalyticsEvent[]
  progress    UserLessonProgress[]

  @@index([moduleId])
  @@index([order])
  @@map("lessons")
}

model UserLessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  progress    Int       @default(0) // 0-100 percentage
  lastWatchedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("user_lesson_progress")
}

model AnalyticsEvent {
  id         String    @id @default(cuid())
  videoId    String?   // Keep for backward compatibility with old videos
  lessonId   String?   // New: reference to lesson
  userId     String?
  eventType  EventType
  progress   Int?
  timestamp  DateTime  @default(now())
  deviceInfo String?
  video      Video?    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  lesson     Lesson?   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([lessonId])
  @@index([videoId])
  @@index([userId])
  @@index([timestamp])
  @@map("analytics_events")
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String   // User who performed the action
  targetUserId String? // User being acted upon (if applicable)
  action      String   // Action type (e.g., 'CATEGORY_ROLE_CHANGE', 'AUTH_ROLE_CHANGE', 'VIDEO_APPROVED', 'VIDEO_REJECTED')
  oldValue    String?  @db.Text // JSON string of old value
  newValue    String?  @db.Text // JSON string of new value
  metadata    String?  @db.Text // Additional metadata as JSON
  timestamp   DateTime @default(now())

  @@index([actorId])
  @@index([targetUserId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}
